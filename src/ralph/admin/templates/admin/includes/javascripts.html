{% load staticfiles ralph_tags %}

{% raven_js %}
<script type="text/javascript">window.__admin_utc_offset__ = "{% filter escapejs %}{% now "Z" %}{% endfilter %}";</script>
<script type="text/javascript">window.__admin_media_prefix__ = "{% static '' %}";</script>
<script type="text/javascript" src="{% static 'admin/js/core.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/jquery.init.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/actions.js' %}"></script>
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/admin/RelatedObjectLookups.js' %}"></script>

<script type="text/javascript" src="{% static 'vendor/js/jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'src/js/ralph.init.js' %}"></script>
<script type="text/javascript" src="{% static "auto-complete-helpers.js" %}"></script>
<script type="text/javascript" src="{% static 'vendor/js/foundation.min.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/js/modernizr.js' %}"></script>
<script type="text/javascript" src="{% static 'src/js/fill-fields.js' %}"></script>

<script>
    (function($){
        $(document).ready(function() {
            $('#filter-button').bind('click', function() {
                /**
                * Because Django change_list uses the form to actions and bulk_edit
                * and sends the data via POST. All filters work through the GET
                * method.
                * We have created an additional form which is responsible for
                * generating GET parameters for filters.
                *
                * Cloned data from #filter-container and insert to #filter-form,
                * then click submit.
                */

                var $form = $('#filter-form');
                $form.empty();
                var $orginal = $('.filter-container');
                var $clone = $orginal.clone();

                var $original_selects = $orginal.find('select');
                // We have to select the <select> because jQuery.clone() does not copy it.
                $clone.find('select').each(function(index, item) {
                  $(item).val($original_selects.eq(index).val());
                });
                $('input, select', $clone).each(function(i, item) {
                  var $item = $(item);
                  if($item.val())
                    $item.appendTo($form);
                });
                $form[0].submit();
            });

            // If you press "enter" in the filter form field
            // run submit on this form. (Default is not working)
            $('.filter-container').on('keypress', function(event) {
                if(event.keyCode == 13) {  // For "enter" key
                    event.preventDefault();
                    $('#filter-button').click();
                    return false;
                }
            });

            $("tr input.action-select").actions();
            var initPopupButtons = function() {
                $('.add-related').click(function(e) {
                    e.preventDefault();
                    showAddAnotherPopup(this);
                });
                $('.related-lookup').click(function(e) {
                    e.preventDefault();
                    showRelatedObjectLookupPopup(this);
                });
                $('.change-related').click(function(e) {
                    e.preventDefault();
                    showRelatedObjectPopup(this);
                });
            }
            initPopupButtons();
            $('.add-row a').click(function() {
                initPopupButtons();
            });

            $('.inline-related').each(function() {
                var group_id = $(this).data('group-id'),
                    prefix = $(this).data('prefix'),
                    add_text = $(this).data('add-text'),
                    delete_text = $(this).data('delete-text');
                (function($) {
                  $("#" + group_id + "-group .tabular.inline-related tbody tr").tabularFormset({
                      prefix: prefix,
                      addText: add_text,
                      deleteText: delete_text
                    });
                })(django.jQuery);
            });
        });
    })(django.jQuery);

    (function($) {
        var tooltipEventSystem = {
            listeners: {},
            hideTimeouts: {},
            proxyFunctions: {
                'show': {
                    old: null
                },
                'hide': {
                    old: null
                }
            },
            addListener: function(evtName, listenerFunc) {
                var self = this;
                if (typeof(self.listeners[evtName]) === 'undefined') {
                    self.listeners[evtName] = [];
                }
                self.listeners[evtName].push(listenerFunc);
            },
            triggerListeners: function(evtName, args) {
                var self = this;
                var cancelEvent = false;
                if (typeof(self.listeners[evtName]) !== 'undefined') {
                    var listeners = self.listeners[evtName];
                    var i;
                    for (i = 0; i < listeners.length; i += 1) {
                        var listener = listeners[i];
                        /*
                            Cancel event only if one of the listeners returns false
                        */
                        var result = (listener.apply(self, args) === false) ? false : true;
                        if (!result) {
                            cancelEvent = true;
                        }
                    }
                }
                return cancelEvent;
            },
            initEventSystem: function() {
                var self = this;
                Object.keys(self.proxyFunctions).forEach(function(funcName) {
                    self.proxyFunctions[funcName].old = self[funcName];
                    self[funcName] = function() {
                        var cancelEvent = self.triggerListeners(funcName, arguments);
                        
                        // if event is not canceled
                        if (!cancelEvent) {
                            self.proxyFunctions[funcName].old.apply(self, arguments);
                        }
                    };
                });
            },
            clearHideTimeout: function(target) {
                var self = this;
                var tooltip = self.getTip(target);
                var tipId = tooltip.attr("id");
                clearTimeout(self.hideTimeouts[tipId]);
            },
            startHideTimeout: function(target) {
                var self = this;
                var tooltip = self.getTip(target);
                var tipId = tooltip.attr("id");
                clearTimeout(self.hideTimeouts[tipId]);
                
                var timeoutDelay = self.settings.hover_delay || 500;
                self.hideTimeouts[tipId] = setTimeout(function() {
                    self.proxyFunctions['hide'].old.call(self, target);
                }, timeoutDelay);
            }
        };
        $.extend(Foundation.libs.tooltip, tooltipEventSystem);
        Foundation.libs.tooltip.initEventSystem();

        Foundation.libs.tooltip.addListener('hide', function(target) {
            var self = this;
            var $tip = self.getTip(target);
            self.startHideTimeout(target);

            function mouseover() {
                self.clearHideTimeout(target);
            }

            function mouseout() {
                self.startHideTimeout(target);
            }

            target.on('mouseover', mouseover);
            target.on('mouseout', mouseout);
            $tip.on('mouseover', mouseover);
            $tip.on('mouseout', mouseout);

            // Stop event from executing
            return false;
        });

        $('li.has-dropdown').on('mouseover', function() {
            var $this = $(this);
            var parent = $(".top-bar");
            var $thisdrop = $this.find(".dropdown").first();
            $thisdrop.css('visibility', 'visible')
                     .css('width', 'auto');

            var dropdowns = parent.find("li.has-dropdown .dropdown");
            dropdowns.each(function() {
                var $drop = $(this);
                if(!$drop.is($thisdrop)) {
                    $drop.css('visibility', 'hidden');
                }
            });
        });

        $(document).foundation();
    })(ralph.jQuery);
</script>
