<!--
hello
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<!-- polymer components -->
<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-form-element-behavior/iron-form-element-behavior.html">

<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">


<dom-module id='badge-input'>
  <template>
    <style>
      :host {
        background-color: red;
      }
    </style>
    <div>
      <!--
        - remove pick
      -->
      <div id='styledPicks'>
        <template is='dom-repeat' items="[[badgesData]]">
          <div>[[item.__str__]]</div>
          <!--
          TODO:: widget look
          TODO:: handle deleting
          TODO:: handle editing
          -->
          <a href='[[item.edit_url]]'><i class="fa fa-pencil"></i></a>
          <i class="fa fa-times delete"></i>
        </template>
      </div>
      <input id='text-getter' is="iron-input">
    </div>
  </template>

  <script>
    Polymer({
      is: "badge-input",
      properties: {
        badgesData: {
          type: Array,
          value: []
        }
      },
      addBadge: function(badgeObject) {
        console.log('addBadge', badgeObject);
        this.push('badgesData', badgeObject);
        this.clearInput();
      },
      setBadges: function(badges) {
        console.log('setBadges', badges);
        this.push('badgesData', badges);
        this.clearInput();
      },
      clear: function() {
        console.log('clear');
        this.set('badgesData', []);
      },
      clearInput: function(badgeObject) {
        console.log('clearInput');
        this.$['text-getter'].value = "";
      },
      ready: function() {
      }
    });
  </script>
</dom-module>



<!--
Autocomplete field.
This widget works in two mode

Usage:
------

### single

Example:

    TODO:: add qualitative doc
    TODO:: missing url param
    <proto-element value="1" > </proto-element>

### multi

Example:
    <proto-element value=""  multi> </proto-element>
-->


<dom-module id='proto-element'>
  <template>
    <style>
    </style>

    <!--
    badges element in future
    -->
    <badge-input id='query-getter' on-change='handleTyping'> </badge-input>

    <iron-ajax
        id='items-getter'
        url="/data_center/datacenterasset/rack/autocomplete"
        params=''
        handle-as="json"
        on-response="populateMenu"
    ></iron-ajax>
    <paper-menu hidden$="{{hideMenu}}" on-iron-activate='elemSelected' id='picker'
      class="dropdown-content" selected='1'>
      <template is="dom-repeat" items="[[menuItems]]">
        <paper-item>[[item.__str__]]</paper-item>
      </template>
    </paper-menu>
    <input type='text' id='selectionStorage' is="iron-input" bind-value="" name='autocomplete'>


  </template>
</dom-module>
<script>
  // register a new element called proto-element
  Polymer({
    is: "proto-element",
    properties: {
      multi: {
        type: Boolean,
        value: false
      },
      hideMenu: {
        type: Boolean,
        value: true
      },
      typed: String,
      fireTreshold: 2,
      valueSeparator: ',',
      menuItems: {
        type: Array,
        value: []
      }
    },
    //TODO:: use listeners
    handleTyping: function(evt, obj) {
      console.log('handleTyping', evt, obj);
      // TODO:: fix: keypressed is late one chars because value is not yet updated
      if (evt.target.value.length < this.fireThreshold) return false;
      // TODO:: find out why regular syntax doesn't work
      this.$['items-getter'].params = {
        "q": evt.target.value
      };
      this.$['items-getter'].generateRequest();
    },
    elemSelected: function(evt, obj) {
      console.log('elemSelected', evt, obj);
      var selectedItem = this.menuItems[obj.selected];
      this.storeSelection(selectedItem);
      this.hideMenu = true;
    },
    populateMenu: function(evt, obj) {
      console.log('populateMenu', evt, obj);
      // handle duplicates
      this.set('menuItems', obj.xhr.response['results']);
      this.hideMenu = false;

    },
    storeSelection: function(elem) {
      console.log('storeSelection', elem);
      if (this.multi) {
        this.$['query-getter'].addBadge(elem);
        if (this.$.selectionStorage.value === "") {
          this.$['selectionStorage'].value = elem.pk;
        } else {
          this.$['selectionStorage'].value += this.valueSeparator + elem.pk;
        }
      } else {
        this.$['query-getter'].setBadges([elem]);
        this.$['selectionStorage'].value = elem.pk;
      }
    },
    behaviors: [
      Polymer.IronFormElementBehavior
    ],
    ready: function() {
    }
  });
</script>

