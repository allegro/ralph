<!--
hello
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<!-- polymer components -->
<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-form-element-behavior/iron-form-element-behavior.html">

<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/iron-input/iron-input.html">


<dom-module id='badge-input'>
  <template>
    <style>
      :host {
      }
      .badge {
      }
      .badge * {
        float: left;
        margin: 0 5px;
      }
      #text-getter{
      }
      .badge, #text-getter{
        float: left;
        width: auto;
      }
    </style>
    <div>
      <div id='badgeContainer'>
        <template is='dom-repeat' items="[[badgesData]]">
          <div class='badge'>
            <span>[[item.__str__]]</span>
            <!--
            TODO:: widget look
            TODO:: handle editing
            -->
            <a href='[[item.edit_url]]'><i class="fa fa-pencil"></i></a>
            <i on-tap="onBadgeRemove" class="fa fa-times delete"></i>
          </div>
        </template>
      </div>
      <input id='text-getter' is="iron-input">
      <div style="clear: both;"></div>
    </div>
  </template>

  <script>
    Polymer({
      is: "badge-input",
      properties: {
        badgesData: {
          type: Array,
          value: function(){return [];}
        }
      },
      addBadge: function(badgeObject) {
        console.log('addBadge', badgeObject);
        this.push('badgesData', badgeObject);
        this.clearInput();
      },
      setBadges: function(badges) {
        console.log('setBadges', badges);
        this.badgesData = badges;
        this.clearInput();
      },
      onBadgeRemove: function(evt, obj) {
        console.log('onBadgeRemove', evt, obj);
        this.splice('badgesData', evt.model.index, 1);
        this.fire('badge-remove', {
            "index": evt.model.index,
            "item": evt.model.item
        });
      },
      setFocusInput: function() {
        console.log('setFocusInput');
        this.$['text-getter'].focus();
      },
      clear: function() {
        console.log('clear');
        this.set('badgesData', []);
      },
      clearInput: function(badgeObject) {
        console.log('clearInput');
        this.$['text-getter'].value = "";
      },
      ready: function() {
      }
    });
  </script>
</dom-module>



<!--
Autocomplete field.
This widget works in two mode

Usage:
------

### single

Example:

    TODO:: add qualitative doc
    TODO:: urls should be passable to this widget, eg. urls
    <proto-element value="1" > </proto-element>

### multi
    TODO:: could be self deducted by looking for comma in - no what if values are empty?

Example:
    <proto-element value=""  multi> </proto-element>
-->


<dom-module id='proto-element'>
  <template>
    <style>
    </style>
    <!--
    badges element in future
    -->
    <badge-input id='query-getter' on-badge-remove="onBadgeRemove" on-keyup='handleTyping'> </badge-input>

    <iron-ajax
        id='by-query-ajax'
        url="/data_center/datacenterasset/rack/autocomplete"
        params=''
        handle-as="json"
        on-response="populateMenu"
    ></iron-ajax>
    <paper-menu hidden$="{{hideMenu}}" on-iron-activate='elemSelected' id='picker'
      class="dropdown-content" selected='1'>
      <template is="dom-repeat" items="[[menuItems]]">
        <paper-item>[[item.__str__]]</paper-item>
      </template>
    </paper-menu>
    <input type='text' is="iron-input" bind-value="{{value}}" name='autocomplete'>
    <iron-ajax
        id='by-id-ajax'
        url="/data_center/rack/autocomplete/details/"
        params=''
        handle-as="json"
        on-response="updateBadges"
    ></iron-ajax>
    <content><content>
  </template>
  <script>
    // register a new element called proto-element
    Polymer({
      is: "proto-element",
      properties: {
        typed: String,
        fireThreshold: {
          type: Number,
          value: 3,
        },
        separator: {
          type: String,
          value: ',',
        },
        value: {
          type: String,
          value: '',
          observer: '_ids2Objs',
        },
        multi: {
          type: Boolean,
          value: false
        },
        hideMenu: {
          type: Boolean,
          value: true
        },
        menuItems: {
          type: Array,
          value: function(){return [];}
        }
      },
      //TODO:: use listeners
      handleTyping: function(evt, obj) {
        console.log('handleTyping', evt, obj);
        if (evt.target.value.length < this.fireThreshold) {
          return false;
        }
        // TODO:: find out why regular syntax doesn't work
        if (evt.target.value === '') return false;
        this.$['by-query-ajax'].params = {
          "q": evt.target.value
        };
        this.$['by-query-ajax'].generateRequest();
      },
      _updateById: function(objId) {
        console.log('_updateById', objId);
        this.value = objId;
      },
      _updateMultiById: function(objId) {
        console.log('_updateMultiById', objId);
        if (this.value === "") {
          this.value = objId
        } else {
          this.value += this.separator + objId;
        }
      },
      updateById: function(objId) {
        console.log('updateById', objId);
        if (this.multi) {
          this._updateMultiById(objId);
        } else {
          this._updateById(objId);
        }
        this.$['query-getter'].setFocusInput();
      },
      elemSelected: function(evt, obj) {
        console.log('elemSelected', evt, obj);
        var selectedItem = this.menuItems[obj.selected];
        this.updateById(selectedItem.pk);
        this.hideMenu = true;
        this.$['query-getter'].setFocusInput();
      },
      populateMenu: function(evt, obj) {
        console.log('populateMenu', evt, obj);
        var foundItems = obj.xhr.response['results'];
        var selectedIds = this.value.split(this.separator);
        var fileteredItems = [];
        for(var idx=0; idx < foundItems.length; idx++) {
          if (selectedIds.indexOf(foundItems[idx].pk.toString()) === -1) {
            fileteredItems.push(foundItems[idx]);
          }
        }
        this.set('menuItems', fileteredItems);
        this.hideMenu = false;

      },
      updateBadges: function(evt, obj) {
        console.log('updateBadges', evt, obj);
        this.$['query-getter'].setBadges(obj.xhr.response['results']);
        var ids = [];
        for(var idx=0; idx < obj.xhr.response['results'].length; idx++) {
          ids.push(obj.xhr.response['results'][idx].pk);
        }
        console.log('ids', ids);
        this.value = ids.join(this.separator);
      },
      onBadgeRemove: function(evt, obj) {
        console.log('onBadgeRemove', evt, obj);
        var ids = this.value.split(this.separator)
        ids.splice(ids.indexOf(obj.item.pk.toString()), 1);
        this.value = ids.join(this.separator);
      },
      _ids2Objs: function(newValue, oldValue) {
        console.log('_ids2Objs', newValue, oldValue);
        if (newValue === "") {
          return false;
        }
        this.$['by-id-ajax'].params = {
          "pk": newValue
        }
        this.$['by-id-ajax'].generateRequest();
      },
      behaviors: [
        Polymer.IronFormElementBehavior
      ],
      ready: function() {
      }
    });
  </script>
</dom-module>
