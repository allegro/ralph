<!--
hello
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<!-- polymer components -->
<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-form-element-behavior/iron-form-element-behavior.html">

<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">


<dom-module id='badge-input'>
  <template>
    <style>
      :host {
        background-color: red;
      }
    </style>
    <div>
      <!--
        - add pick
        - remove pick
        - clear pick
      -->
      <div id='styledPicks'>
        <template is='dom-repeat' items="[[badgesData]]">
          <div>[[item.__str__]]</div>
          <a href='[[item.edit_url]]'><i class="fa fa-pencil"></i></a>
          <i class="fa fa-times delete"></i>
        </template>
      </div>
      <input id='text-getter' is="iron-input">
    </div>
  </template>

  <script>
    Polymer({
      is: "badge-input",
      properties: {
        badgesData: {
          type: Array,
          value: function(){return [];}
        }
      },
      addBadge: function(badgeObject) {
        console.log('addBadge', badgeObject);
        this.push('badgesData', badgeObject);
      },
      ready: function() {
      }
    });
  </script>
</dom-module>



<dom-module id='proto-element'>
<!--
TODO::
- add `multi` feature
-->

  <template>
    <style>
    </style>

    <!--
    badges element in future
    -->
    <badge-input id='query-getter' on-keypress='handleTyping'> </badge-input>

    <iron-ajax
        id='items-getter'
        url="/data_center/datacenterasset/rack/autocomplete"
        params=''
        handle-as="json"
        on-response="populateMenu"
    ></iron-ajax>
    <paper-menu hidden$="{{hideMenu}}" on-iron-activate='elemSelected' id='picker'
      class="dropdown-content" selected='1'>
      <template is="dom-repeat" items="[[menuItems]]">
        <paper-item>[[item.__str__]]</paper-item>
      </template>
    </paper-menu>
    <input type='text' id='selectionStorage' is="iron-input" bind-value="" name='autocomplete'>


  </template>
</dom-module>
<script>
  // register a new element called proto-element
  Polymer({
    is: "proto-element",
    properties: {
      multi: {
        type: Boolean,
        value: false
      },
      hideMenu: {
        type: Boolean,
        value: true
      },
      typed: String,
      menuItems: {
        type: Array,
        value: []
      }
    },
    //TODO:: use listeners
    handleTyping: function(evt, obj) {
      console.log('handleTyping');
      // TODO:: fire only when 3 as element's property
      // TODO:: find out why regular syntax doesn't work
      this.$['items-getter'].params = {
        //TODO:: handle real value
        "q": "rack"
      };
      this.$['items-getter'].generateRequest();
    },
    elemSelected: function(evt, obj) {
      console.log('elemSelected', evt, obj);
      var selectedItem = this.menuItems[obj.selected];
      this.storeSelection(selectedItem);
      this.hideMenu = true;
    },
    populateMenu: function(evt, obj) {
      console.log('populateMenu', evt, obj);
      // handle duplicates
      this.set('menuItems', obj.xhr.response['results']);
      this.hideMenu = false;
      console.log(this.$['menuItems']);

    },
    storeSelection: function(elem) {
      console.log('storeSelection', elem);
      if (this.multi) {
        //TODO:: handle multi here
        throw Error("NotImplemented");
      } else {
        this.$['query-getter'].addBadge(elem);
        this.$['selectionStorage'].value = elem.pk;
      }
    },
    behaviors: [
      Polymer.IronFormElementBehavior
    ],
    ready: function() {
    }
  });
</script>

