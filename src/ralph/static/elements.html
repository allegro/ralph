<!--
hello
-->

<link rel="import" href="bower_components/polymer/polymer.html">

<!-- polymer components -->
<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-form-element-behavior/iron-form-element-behavior.html">

<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">


<dom-module id='badge-input'>
  <template>
    <style>
      :host {
        background-color: red;
      }
    </style>
    <div>
      <!--
        - remove pick
      -->
      <div id='styledPicks'>
        <template is='dom-repeat' items="[[badgesData]]">
          <div>[[item.__str__]]</div>
          <!--
          TODO:: widget look
          TODO:: handle editing
          -->
          <a href='[[item.edit_url]]'><i class="fa fa-pencil"></i></a>
          <i on-tap="onBadgeRemove" class="fa fa-times delete"></i>
        </template>
      </div>
      <input id='text-getter' is="iron-input">
    </div>
  </template>

  <script>
    Polymer({
      is: "badge-input",
      properties: {
        badgesData: {
          type: Array,
          value: []
        }
      },
      addBadge: function(badgeObject) {
        console.log('addBadge', badgeObject);
        this.push('badgesData', badgeObject);
        this.clearInput();
      },
      setBadges: function(badges) {
        console.log('setBadges', badges);
        this.badgesData = badges;
        this.clearInput();
      },
      onBadgeRemove: function(evt, obj) {
        console.log('onBadgeRemove', evt, obj);
        this.badgesData = this.badgesData.splice(evt.model.item.index, 1)
        this.fire('badge-remove', {
            "index": evt.model.index,
            "item": evt.model.item
        });
      },
      clear: function() {
        console.log('clear');
        this.set('badgesData', []);
      },
      clearInput: function(badgeObject) {
        console.log('clearInput');
        this.$['text-getter'].value = "";
      },
      ready: function() {
      }
    });
  </script>
</dom-module>



<!--
Autocomplete field.
This widget works in two mode

Usage:
------

### single

Example:

    TODO:: do not suggest picked items
    TODO:: add qualitative doc
    TODO:: urls should be passable to this widget, eg. urls
    <proto-element value="1" > </proto-element>

### multi
    TODO:: could be self deducted by looking for comma in - no what if values are empty?

Example:
    <proto-element value=""  multi> </proto-element>
-->


<dom-module id='proto-element'>
  <template>
    <style>
    </style>

    <!--
    badges element in future
    -->
    <badge-input id='query-getter' on-badge-remove="onBadgeRemove" on-keyup='handleTyping'> </badge-input>

    <iron-ajax
        id='by-query-ajax'
        url="/data_center/datacenterasset/rack/autocomplete"
        params=''
        handle-as="json"
        on-response="populateMenu"
    ></iron-ajax>
    <paper-menu hidden$="{{hideMenu}}" on-iron-activate='elemSelected' id='picker'
      class="dropdown-content" selected='1'>
      <template is="dom-repeat" items="[[menuItems]]">
        <paper-item>[[item.__str__]]</paper-item>
      </template>
    </paper-menu>
    <input type='text' id='selectionStorage' is="iron-input" bind-value="{{value}}" name='autocomplete'>
    <iron-ajax
        id='by-id-ajax'
        url="/assets/assetmodel/autocomplete/details/"
        params=''
        handle-as="json"
        on-response="updateBadges"
    ></iron-ajax>


  </template>
</dom-module>
<script>
  // register a new element called proto-element
  Polymer({
    is: "proto-element",
    properties: {
      typed: String,
      fireTreshold: 2,
      valueSeparator: {
        type: String,
        value: ',',
      },
      value: {
        type: String,
        value: '',
        observer: '_ids2Objs',
      },
      multi: {
        type: Boolean,
        value: false
      },
      hideMenu: {
        type: Boolean,
        value: true
      },
      menuItems: {
        type: Array,
        value: []
      }
    },
    //TODO:: use listeners
    handleTyping: function(evt, obj) {
      console.log('handleTyping', evt, obj);
      if (evt.target.value.length < this.fireThreshold) return false;
      // TODO:: find out why regular syntax doesn't work
      this.$['by-query-ajax'].params = {
        "q": evt.target.value
      };
      this.$['by-query-ajax'].generateRequest();
    },
    elemSelected: function(evt, obj) {
      console.log('elemSelected', evt, obj);
      var selectedItem = this.menuItems[obj.selected];
      this.storeSelection(selectedItem);
      this.hideMenu = true;
    },
    populateMenu: function(evt, obj) {
      console.log('populateMenu', evt, obj);
      // handle duplicates
      this.set('menuItems', obj.xhr.response['results']);
      this.hideMenu = false;

    },
    updateBadges: function(evt, obj) {
      console.log('updateBadges', evt, obj);
      this.$['query-getter'].setBadges(obj.xhr.response['results']);
    },
    storeSelection: function(elem) {
      console.log('storeSelection', elem);
      if (this.multi) {
        this.$['query-getter'].addBadge(elem);
        if (this.$.selectionStorage.value === "") {
          this.$['selectionStorage'].value = elem.pk;
        } else {
          this.$.selectionStorage.value += this.valueSeparator + elem.pk;
        }
      } else {
        this.$['query-getter'].setBadges([elem]);
        this.$['selectionStorage'].value = elem.pk;
      }
    },
    onBadgeRemove: function(evt, obj) {
      console.log('onBadgeRemove', evt, obj);
      var ids = this.$['selectionStorage'].value.split(this.valueSeparator)
      ids.splice(obj.index, 1);
      this.$['selectionStorage'].value = ids.join(this.valueSeparator);
    },
    _ids2Objs: function(newValue, oldValue) {
      console.log('_ids2Objs', newValue, oldValue);
      this.$['by-id-ajax'].params = {
        "pk": newValue
      }
      this.$['by-id-ajax'].generateRequest();
      this.$['selectionStorage'].value = newValue;
    },
    behaviors: [
      Polymer.IronFormElementBehavior
    ],
    ready: function() {
    }
  });
</script>

